<div class="main-content">
  <div class="page-header">
    <h1>{{ 'Main.Title' | translate }}</h1>
    <p>{{ 'Main.Description' | translate }}</p>
  </div>

  <!-- Tab Navigation following Ex Libris patterns -->
  <mat-tab-group class="processing-tabs" animationDuration="300ms">
    <!-- Manual Entry Tab - Existing Implementation -->
    <mat-tab [label]="'Tabs.ManualEntry' | translate">
      <div class="tab-content">
        <form class="file-form" [formGroup]="form" (ngSubmit)="submit()">
          <section class="form-section">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Asset ID</mat-label>
              <input matInput formControlName="assetId" placeholder="e.g. 12345678900001234" />
              <mat-error *ngIf="form.get('assetId')?.hasError('required')">Asset ID is required.</mat-error>
            </mat-form-field>
          </section>

  <section class="file-type-hint" *ngIf="fileTypes.length">
    <h2>Available file types</h2>
    <p class="hint-text">Select one of the configured file types when uploading each file.</p>
    <div class="file-type-list">
      <div class="file-type-item" *ngFor="let type of fileTypes">
        <span class="code">{{ type.value }}</span>
        <span class="description" *ngIf="type.description && type.description !== type.value">{{ type.description }}</span>
      </div>
    </div>
  </section>

  <section formArrayName="files" class="files-section">
    <mat-card class="file-card" *ngFor="let fileGroup of files.controls; let i = index; trackBy: trackByIndex" [formGroupName]="i">
      <div class="file-card__header">
        <h2>File {{ i + 1 }}</h2>
        <button mat-icon-button type="button" color="warn" (click)="removeFile(i)" *ngIf="files.length > 1">
          <mat-icon>delete</mat-icon>
        </button>
      </div>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>File name</mat-label>
        <input matInput formControlName="title" placeholder="Display name shown in Esploro" />
        <mat-error *ngIf="fileGroup.get('title')?.hasError('required')">File name is required.</mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>File URL</mat-label>
        <input matInput formControlName="url" placeholder="https://example.com/file.pdf" />
        <mat-hint>Provide the fully qualified URL from which Esploro can download the file.</mat-hint>
        <mat-error *ngIf="fileGroup.get('url')?.hasError('required')">File URL is required.</mat-error>
        <mat-error *ngIf="fileGroup.get('url')?.hasError('pattern')">Enter a valid http(s) URL.</mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Description</mat-label>
        <textarea matInput formControlName="description" rows="2" placeholder="Optional description shown to researchers"></textarea>
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>File type</mat-label>
        <mat-select formControlName="type" [disabled]="loadingFileTypes || loadingAssetMetadata || filteredFileTypes.length === 0">
          <mat-option *ngFor="let type of filteredFileTypes" [value]="type.id">
            {{ type.targetCode }}<span *ngIf="type.id"> (ID: {{ type.id }})</span>
          </mat-option>
        </mat-select>
        <mat-hint *ngIf="loadingFileTypes || loadingAssetMetadata">Loading file type categoriesâ€¦</mat-hint>
        <mat-hint *ngIf="!loadingFileTypes && !loadingAssetMetadata && filteredFileTypes.length > 0 && currentAssetType">
          Showing categories compatible with {{ currentAssetType }} assets. The ID value will be used in the API call.
        </mat-hint>
        <mat-hint *ngIf="!loadingFileTypes && !loadingAssetMetadata && filteredFileTypes.length > 0 && !currentAssetType">
          Select a file type category. The ID value will be used in the API call.
        </mat-hint>
        <mat-hint *ngIf="!loadingFileTypes && !loadingAssetMetadata && filteredFileTypes.length === 0">
          No compatible file types found for this asset type.
        </mat-hint>
        <mat-error *ngIf="fileGroup.get('type')?.hasError('required')">Select a file type.</mat-error>
      </mat-form-field>

      <mat-checkbox formControlName="supplemental">Supplemental file</mat-checkbox>
    </mat-card>
  </section>

  <div class="add-file-row">
    <button mat-stroked-button color="primary" type="button" (click)="addFile()">
      <mat-icon>add</mat-icon>
      <span>Add another file</span>
    </button>
  </div>

  <div class="form-actions">
    <button mat-flat-button color="primary" type="submit" [disabled]="submitting">Submit files</button>
  </div>

  <mat-progress-bar *ngIf="submitting" mode="indeterminate"></mat-progress-bar>

  <div class="submission-result" *ngIf="submissionResult" [ngClass]="submissionResult.type">
    {{ submissionResult.message }}
  </div>
        </form>
      </div>
    </mat-tab>

    <!-- CSV Upload Tab - New Implementation -->
    <mat-tab [label]="'Tabs.CSVUpload' | translate">
      <div class="tab-content">
        <app-csv-processor
          [fileTypes]="fileTypes"
          [assetFileAndLinkTypes]="assetFileAndLinkTypes"
          (batchProcessed)="onBatchProcessed($event)"
          (downloadReady)="onDownloadReady($event)">
        </app-csv-processor>
      </div>
    </mat-tab>
  </mat-tab-group>

  <!-- Results Section -->
  <div *ngIf="showResults" class="results-section">
    <app-processing-results
      [processedData]="processedAssets"
      [downloadUrl]="mmsIdDownloadUrl"
      [showInstructions]="showWorkflowInstructions">
    </app-processing-results>
  </div>
</div>