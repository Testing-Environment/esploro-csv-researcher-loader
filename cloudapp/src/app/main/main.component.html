<mat-tab-group>
  <!-- Manual Entry Tab -->
  <mat-tab label="Manual Entry">
    <div class="tab-content">
      <h1>Add files to Esploro assets</h1>

      <!-- Stage 1: Entry Form -->
      <div *ngIf="currentStage === 1" class="stage-1">
        <p class="instructions">
          Enter details for each file you want to add. Each row represents one file.
          You can add files to the same asset or different assets.
        </p>

        <form [formGroup]="manualForm">
          <div formArrayName="entries" class="entries-section">
            <mat-card class="entry-card" *ngFor="let entry of manualEntries.controls; let i = index; trackBy: trackByIndex" [formGroupName]="i">
              <div class="entry-card__header">
                <h3>File Entry {{ i + 1 }}</h3>
                <button mat-icon-button type="button" color="warn" (click)="removeEntry(i)" *ngIf="manualEntries.length > 1">
                  <mat-icon>delete</mat-icon>
                </button>
              </div>

              <div class="entry-fields">
                <mat-form-field appearance="outline" class="field">
                  <mat-label>Asset ID</mat-label>
                  <input matInput formControlName="assetId" placeholder="e.g. 12345678900001234" />
                  <mat-error *ngIf="entry.get('assetId')?.hasError('required')">Asset ID is required</mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline" class="field">
                  <mat-label>Title</mat-label>
                  <input matInput formControlName="title" placeholder="Display name for the file" />
                  <mat-error *ngIf="entry.get('title')?.hasError('required')">Title is required</mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline" class="field">
                  <mat-label>URL</mat-label>
                  <input matInput formControlName="url" placeholder="https://example.com/file.pdf" />
                  <mat-error *ngIf="entry.get('url')?.hasError('required')">URL is required</mat-error>
                  <mat-error *ngIf="entry.get('url')?.hasError('pattern')">Enter a valid http(s) URL</mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline" class="field full-width">
                  <mat-label>Description</mat-label>
                  <textarea matInput formControlName="description" rows="2" placeholder="Optional description"></textarea>
                </mat-form-field>

                <mat-form-field appearance="outline" class="field">
                  <mat-label>Supplemental</mat-label>
                  <mat-select formControlName="supplemental">
                    <mat-option [value]="true">True</mat-option>
                    <mat-option [value]="false">False</mat-option>
                  </mat-select>
                  <mat-error *ngIf="entry.get('supplemental')?.hasError('required')">Please select</mat-error>
                </mat-form-field>
              </div>
            </mat-card>
          </div>

          <div class="add-entry-row">
            <button mat-stroked-button color="primary" type="button" (click)="addEntry()">
              <mat-icon>add</mat-icon>
              <span>Add another row</span>
            </button>
          </div>

          <div class="form-actions">
            <button mat-flat-button color="primary" type="button" (click)="validateAndProceed()" [disabled]="validating">
              Validate & Proceed
            </button>
          </div>

          <mat-progress-bar *ngIf="validating" mode="indeterminate"></mat-progress-bar>
        </form>
      </div>

      <!-- Stage 2: File Type Selection -->
      <div *ngIf="currentStage === 2" class="stage-2">
        <p class="instructions">
          Select file types for each entry. The available file types are based on the asset type.
        </p>

        <form [formGroup]="stage2Form">
          <div formArrayName="fileTypes" class="file-type-section">
            <mat-card class="file-type-card" *ngFor="let entry of stage2FileTypes.controls; let i = index; trackBy: trackByIndex" [formGroupName]="i">
              <div class="file-info">
                <h4>File {{ i + 1 }}: {{ validatedEntries[i]?.title }}</h4>
                <p class="asset-info">Asset ID: {{ validatedEntries[i]?.assetId }} | URL: {{ validatedEntries[i]?.url }}</p>
              </div>

              <mat-form-field appearance="outline" class="full-width">
                <mat-label>File Type</mat-label>
                <mat-select formControlName="type">
                  <mat-option *ngFor="let type of getFileTypesForEntry(i)" [value]="type.value">
                    {{ type.value }}<span *ngIf="type.description && type.description !== type.value"> — {{ type.description }}</span>
                  </mat-option>
                </mat-select>
                <mat-error *ngIf="entry.get('type')?.hasError('required')">File type is required</mat-error>
              </mat-form-field>
            </mat-card>
          </div>

          <div class="form-actions">
            <button mat-stroked-button type="button" (click)="backToStage1()">
              <mat-icon>arrow_back</mat-icon>
              Back
            </button>
            <button mat-flat-button color="primary" type="button" (click)="submitWorkflow()" [disabled]="processing">
              Submit & Process
            </button>
          </div>

          <mat-progress-bar *ngIf="processing" mode="indeterminate"></mat-progress-bar>
        </form>
      </div>

      <!-- Results Display -->
      <div *ngIf="workflowResult" class="workflow-result" [ngClass]="workflowResult.success ? 'success' : 'error'">
        <h2>{{ workflowResult.success ? 'Success!' : 'Workflow Completed with Errors' }}</h2>
        
        <div class="result-summary">
          <p><strong>Set ID:</strong> {{ workflowResult.setId }}</p>
          <p><strong>Job ID:</strong> {{ workflowResult.jobId }}</p>
          <p><strong>Job Status:</strong> {{ workflowResult.jobStatus }}</p>
          <p><strong>Files Processed:</strong> {{ workflowResult.filesProcessed }}</p>
          <p><strong>Assets Processed:</strong> {{ workflowResult.assetsProcessed }}</p>
        </div>

        <div *ngIf="workflowResult.assetVerifications" class="asset-verifications">
          <h3>Asset Verification Results</h3>
          <mat-card *ngFor="let verification of workflowResult.assetVerifications" class="verification-card">
            <p><strong>Asset ID:</strong> {{ verification.assetId }}</p>
            <p>Initial Files: {{ verification.initialFileCount }} → Final Files: {{ verification.finalFileCount }}</p>
            <p>Files Added: {{ verification.filesAdded }}</p>
            <p class="status" [class.success]="verification.success" [class.error]="!verification.success">
              {{ verification.success ? '✓ Success' : '✗ Failed' }}
            </p>
          </mat-card>
        </div>

        <div *ngIf="workflowResult.errors && workflowResult.errors.length > 0" class="errors">
          <h3>Errors</h3>
          <ul>
            <li *ngFor="let error of workflowResult.errors">{{ error }}</li>
          </ul>
        </div>

        <div class="form-actions">
          <button mat-flat-button color="primary" (click)="resetWorkflow()">Start New Upload</button>
        </div>
      </div>
    </div>
  </mat-tab>

  <!-- CSV Upload Tab -->
  <mat-tab label="CSV Upload">
    <div class="tab-content">
      <h1>Upload CSV File</h1>
      
      <p class="instructions">
        Upload a CSV file with asset and file information. The file will be validated and processed automatically.
      </p>

      <div class="csv-actions">
        <button mat-stroked-button color="accent" (click)="downloadTemplate()">
          <mat-icon>download</mat-icon>
          Download Template CSV
        </button>

        <div class="file-upload">
          <button mat-flat-button color="primary" (click)="fileInput.click()">
            <mat-icon>upload_file</mat-icon>
            Load CSV File
          </button>
          <input #fileInput type="file" accept=".csv" style="display: none" (change)="onCsvFileSelected($event)" />
          <span *ngIf="selectedCsvFile" class="file-name">{{ selectedCsvFile.name }}</span>
        </div>
      </div>

      <div *ngIf="csvProcessing" class="csv-processing">
        <mat-progress-bar mode="indeterminate"></mat-progress-bar>
        <p>Processing CSV file...</p>
      </div>

      <div *ngIf="csvResult" class="csv-result">
        <p>{{ csvResult }}</p>
      </div>
    </div>
  </mat-tab>

  <!-- Bulk Update Tab -->
  <mat-tab label="Bulk Update">
    <div class="tab-content">
      <h1>Bulk Update Assets</h1>
      
      <p class="instructions">
        Add the same file URL to multiple assets at once. Enter one asset ID per line.
      </p>

      <form [formGroup]="bulkForm" (ngSubmit)="submitBulkUpdate()">
        <mat-form-field appearance="outline" class="field full-width">
          <mat-label>Asset IDs (one per line)</mat-label>
          <textarea matInput formControlName="assetIds" rows="6" placeholder="12345678900001234&#10;12345678900005678&#10;..."></textarea>
          <mat-error *ngIf="bulkForm.get('assetIds')?.hasError('required')">Please enter at least one asset ID</mat-error>
        </mat-form-field>

        <div class="entry-fields">
          <mat-form-field appearance="outline" class="field">
            <mat-label>Title</mat-label>
            <input matInput formControlName="title" placeholder="Display name for the file" />
            <mat-error *ngIf="bulkForm.get('title')?.hasError('required')">Title is required</mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="field">
            <mat-label>URL</mat-label>
            <input matInput formControlName="url" placeholder="https://example.com/file.pdf" />
            <mat-error *ngIf="bulkForm.get('url')?.hasError('required')">URL is required</mat-error>
            <mat-error *ngIf="bulkForm.get('url')?.hasError('pattern')">Enter a valid http(s) URL</mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="field full-width">
            <mat-label>Description</mat-label>
            <textarea matInput formControlName="description" rows="2" placeholder="Optional description"></textarea>
          </mat-form-field>

          <mat-form-field appearance="outline" class="field">
            <mat-label>File Type</mat-label>
            <mat-select formControlName="type">
              <mat-option *ngFor="let type of fileTypes" [value]="type.value">
                {{ type.description || type.value }}
              </mat-option>
            </mat-select>
            <mat-error *ngIf="bulkForm.get('type')?.hasError('required')">File type is required</mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="field">
            <mat-label>Supplemental</mat-label>
            <mat-select formControlName="supplemental">
              <mat-option [value]="false">False</mat-option>
              <mat-option [value]="true">True</mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <div class="form-actions">
          <button mat-flat-button color="primary" type="submit" [disabled]="bulkSubmitting || bulkForm.invalid">
            <mat-spinner *ngIf="bulkSubmitting" diameter="20"></mat-spinner>
            <span *ngIf="!bulkSubmitting">Submit Bulk Update</span>
            <span *ngIf="bulkSubmitting">Processing...</span>
          </button>
          <button mat-stroked-button type="button" (click)="resetBulkForm()" [disabled]="bulkSubmitting">Reset</button>
        </div>
      </form>

      <div *ngIf="bulkUpdateResult.length > 0" class="bulk-results">
        <h2>Bulk Update Results</h2>
        <mat-card *ngFor="let result of bulkUpdateResult" [ngClass]="result.success ? 'success-card' : 'error-card'">
          <h3>Asset: {{ result.assetId }}</h3>
          <p *ngIf="result.success"><mat-icon class="status-icon success">check_circle</mat-icon> Successfully updated</p>
          <p *ngIf="!result.success"><mat-icon class="status-icon error">error</mat-icon> {{ result.error }}</p>
        </mat-card>
      </div>
    </div>
  </mat-tab>

  <!-- URL Validation Tab -->
  <mat-tab label="URL Validation">
    <div class="tab-content">
      <h1>Validate URLs</h1>
      
      <p class="instructions">
        Check if URLs are accessible. Enter one URL per line.
      </p>

      <form [formGroup]="urlValidationForm" (ngSubmit)="validateUrls()">
        <mat-form-field appearance="outline" class="field full-width">
          <mat-label>URLs (one per line)</mat-label>
          <textarea matInput formControlName="urls" rows="8" placeholder="https://example.com/file1.pdf&#10;https://example.com/file2.pdf&#10;..."></textarea>
          <mat-error *ngIf="urlValidationForm.get('urls')?.hasError('required')">Please enter at least one URL</mat-error>
        </mat-form-field>

        <div class="form-actions">
          <button mat-flat-button color="primary" type="submit" [disabled]="validatingUrls || urlValidationForm.invalid">
            <mat-spinner *ngIf="validatingUrls" diameter="20"></mat-spinner>
            <span *ngIf="!validatingUrls">Validate URLs</span>
            <span *ngIf="validatingUrls">Validating...</span>
          </button>
          <button mat-stroked-button type="button" (click)="resetUrlValidation()" [disabled]="validatingUrls">Reset</button>
        </div>
      </form>

      <div *ngIf="urlValidationResults.length > 0" class="url-results">
        <h2>URL Validation Results</h2>
        <mat-card *ngFor="let result of urlValidationResults" [ngClass]="result.accessible ? 'success-card' : 'error-card'">
          <h3>{{ result.url }}</h3>
          <p *ngIf="result.accessible"><mat-icon class="status-icon success">check_circle</mat-icon> Accessible (Status: {{ result.status }})</p>
          <p *ngIf="!result.accessible"><mat-icon class="status-icon error">error</mat-icon> {{ result.error || 'Not accessible' }} (Status: {{ result.status }})</p>
        </mat-card>
      </div>
    </div>
  </mat-tab>
</mat-tab-group>