<div class="main-content">
  <div class="page-header">
    <h1>{{ 'Main.Title' | translate }}</h1>
    <p>{{ 'Main.Description' | translate }}</p>
  </div>

  <!-- Tab Navigation following Ex Libris patterns -->
  <mat-tab-group class="processing-tabs" animationDuration="300ms">
    <!-- Manual Entry Tab - Existing Implementation -->
    <mat-tab [label]="'Tabs.ManualEntry' | translate">
      <div class="tab-content">
        <form class="file-form" [formGroup]="form" (ngSubmit)="submitWithSelectedTypes()" novalidate>
          <ng-container [ngSwitch]="stage">
            <ng-container *ngSwitchCase="'stage1'">
              <div class="stage-callout" role="note">
                <mat-icon color="primary">info</mat-icon>
                <div class="stage-callout__content">
                  <h2>{{ 'ManualEntry.Stage1CalloutTitle' | translate }}</h2>
                  <p>{{ 'ManualEntry.Stage1CalloutDescription' | translate }}</p>
                  <p>{{ 'ManualEntry.Stage1CalloutSkip' | translate }}</p>
                </div>
              </div>

              <div class="field-toggle-row">
                <mat-slide-toggle
                  color="primary"
                  [checked]="fileTypeFieldEnabled"
                  (change)="onFileTypeToggleChange($event.checked)">
                  {{ 'ManualEntry.Toggles.FileTypeField' | translate }}
                </mat-slide-toggle>
              </div>

              <div class="toggle-callout" *ngIf="fileTypeFieldEnabled">
                <mat-icon color="primary">assignment</mat-icon>
                <div class="toggle-callout__content">
                  <h3>{{ 'ManualEntry.Messages.FileTypeToggleOnCalloutTitle' | translate }}</h3>
                  <p>{{ 'ManualEntry.Messages.FileTypeToggleOnCallout' | translate }}</p>
                </div>
              </div>

              <section class="file-type-hint" *ngIf="fileTypes.length">
                <h2>{{ 'ManualEntry.FileTypesTitle' | translate }}</h2>
                <p class="hint-text">{{ 'ManualEntry.FileTypesHint' | translate }}</p>
                <div class="file-type-list">
                  <div class="file-type-item" *ngFor="let type of fileTypes">
                    <span class="code">{{ type.code }}</span>
                    <span class="description" *ngIf="type.description && type.description !== type.code">{{ type.description }}</span>
                  </div>
                </div>
              </section>

              <section formArrayName="entries" class="files-section">
                <mat-card
                  class="file-card"
                  *ngFor="let entryGroup of entries.controls; let i = index; trackBy: trackByIndex"
                  [formGroupName]="i"
                  [ngClass]="[getRowStateClass(entryGroup), isAssetInvalid(i) ? 'invalid-asset' : '']">
                  <div class="file-card__header">
                    <div class="file-card__heading">
                      <h2>{{ 'ManualEntry.Stage1FileHeading' | translate:{ index: i + 1 } }}</h2>
                      <span
                        class="row-state-chip"
                        [ngClass]="getRowStateClass(entryGroup)"
                        [matTooltip]="getRowStateTooltipKey(entryGroup) | translate"
                        matTooltipShowDelay="150">
                        <mat-icon>{{ getRowStateIcon(entryGroup) }}</mat-icon>
                        <span>{{ getRowStateLabelKey(entryGroup) | translate }}</span>
                      </span>
                    </div>
                    <div class="file-card__actions">
                      <button
                        mat-icon-button
                        type="button"
                        (click)="duplicateEntry(i)"
                        [disabled]="assetValidationInProgress || submitting"
                        [matTooltip]="'ManualEntry.Actions.Duplicate' | translate"
                        [attr.aria-label]="'ManualEntry.Actions.Duplicate' | translate">
                        <mat-icon>content_copy</mat-icon>
                      </button>
                      <button
                        mat-icon-button
                        type="button"
                        color="warn"
                        (click)="removeEntry(i)"
                        *ngIf="entries.length > 1"
                        [disabled]="assetValidationInProgress || submitting"
                        [matTooltip]="'ManualEntry.Actions.Remove' | translate"
                        [attr.aria-label]="'ManualEntry.Actions.Remove' | translate">
                        <mat-icon>delete</mat-icon>
                      </button>
                    </div>
                  </div>

                  <ng-container *ngIf="getAssetMetadataForEntry(entryGroup) as metadata">
                    <div class="asset-metadata">
                      <div class="asset-metadata__header">
                        <mat-icon>inventory_2</mat-icon>
                        <div>
                          <div class="asset-metadata__title">
                            {{ metadata.title || ('ManualEntry.Labels.AssetTitleFallback' | translate) }}
                          </div>
                          <div class="asset-metadata__type" *ngIf="metadata.assetType">
                            {{ 'ManualEntry.Labels.AssetType' | translate:{ type: metadata.assetType } }}
                          </div>
                        </div>
                      </div>

                      <ng-container *ngIf="metadata.files?.length as fileCount; else noExistingFiles">
                        <div class="asset-metadata__files">
                          <div class="existing-file" *ngFor="let existing of metadata.files | slice:0:existingFilePreviewLimit">
                            <mat-icon>attach_file</mat-icon>
                            <div>
                              <div class="existing-file__title">
                                {{ existing.title || ('ManualEntry.Labels.UntitledFile' | translate) }}
                              </div>
                              <a
                                *ngIf="existing.url; else existingUrlMissing"
                                class="existing-file__url"
                                [href]="existing.url"
                                target="_blank"
                                rel="noopener"
                                matTooltip="{{ existing.url }}">
                                {{ existing.url }}
                              </a>
                              <ng-template #existingUrlMissing>
                                <span class="existing-file__url existing-file__url--missing">
                                  {{ 'ManualEntry.Labels.AssetUrlMissing' | translate }}
                                </span>
                              </ng-template>
                            </div>
                          </div>
                          <div class="existing-file existing-file--more" *ngIf="getExistingFileOverflowCount(metadata) > 0">
                            <mat-icon>more_horiz</mat-icon>
                            <span>{{ 'ManualEntry.Labels.MoreFiles' | translate:{ count: getExistingFileOverflowCount(metadata) } }}</span>
                          </div>
                        </div>
                      </ng-container>
                      <ng-template #noExistingFiles>
                        <p class="asset-metadata__empty">{{ 'ManualEntry.Messages.NoExistingFiles' | translate }}</p>
                      </ng-template>

                      <div class="status-hint status-hint--warning" *ngIf="isUrlAlreadyOnAsset(entryGroup, metadata)">
                        <mat-icon>link_off</mat-icon>
                        <span>{{ 'ManualEntry.Messages.UrlAlreadyAttached' | translate }}</span>
                      </div>
                    </div>
                  </ng-container>

                  <div class="status-hint status-hint--info" *ngIf="isRowState(entryGroup, 'pendingNew')">
                    <mat-icon>lightbulb</mat-icon>
                    <span>{{ 'ManualEntry.Messages.PendingNewAsset' | translate }}</span>
                  </div>
                  <div class="status-hint status-hint--info" *ngIf="isRowState(entryGroup, 'validatedExisting')">
                    <mat-icon>inventory</mat-icon>
                    <span>{{ 'ManualEntry.Messages.ValidatedExisting' | translate }}</span>
                  </div>

                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>{{ 'ManualEntry.Fields.AssetId' | translate }}</mat-label>
                    <input matInput formControlName="assetId" placeholder="e.g. 12345678900001234" />
                    <mat-error *ngIf="entryGroup.get('assetId')?.hasError('required')">{{ 'ManualEntry.Errors.AssetIdRequired' | translate }}</mat-error>
                    <mat-error *ngIf="entryGroup.get('assetId')?.hasError('invalidAsset')">{{ 'ManualEntry.Errors.AssetIdInvalid' | translate }}</mat-error>
                    <mat-error *ngIf="entryGroup.get('assetId')?.hasError('duplicateAssetUrl')">{{ 'ManualEntry.Errors.AssetUrlDuplicate' | translate }}</mat-error>
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>{{ 'ManualEntry.Fields.FileTitle' | translate }}</mat-label>
                    <input matInput formControlName="title" placeholder="{{ 'ManualEntry.Placeholders.FileTitle' | translate }}" />
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>{{ 'ManualEntry.Fields.FileUrl' | translate }}</mat-label>
                    <input matInput formControlName="url" placeholder="https://example.com/file.pdf" />
                    <mat-hint>{{ 'ManualEntry.Hints.FileUrl' | translate }}</mat-hint>
                    <mat-error *ngIf="entryGroup.get('url')?.hasError('required')">{{ 'ManualEntry.Errors.UrlRequired' | translate }}</mat-error>
                    <mat-error *ngIf="entryGroup.get('url')?.hasError('pattern')">{{ 'ManualEntry.Errors.UrlFormat' | translate }}</mat-error>
                    <mat-error *ngIf="entryGroup.get('url')?.hasError('duplicateAssetUrl')">{{ 'ManualEntry.Errors.AssetUrlDuplicate' | translate }}</mat-error>
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>{{ 'ManualEntry.Fields.Description' | translate }}</mat-label>
                    <textarea matInput formControlName="description" rows="2" placeholder="{{ 'ManualEntry.Placeholders.Description' | translate }}"></textarea>
                  </mat-form-field>

                  <mat-checkbox formControlName="supplemental">{{ 'ManualEntry.Fields.Supplemental' | translate }}</mat-checkbox>
                </mat-card>
              </section>

              <div class="add-file-row">
                <button mat-stroked-button color="primary" type="button" (click)="addEntry()">
                  <mat-icon>add</mat-icon>
                  <span>{{ 'ManualEntry.Actions.AddAnother' | translate }}</span>
                </button>
              </div>

              <div class="form-actions stage1-actions">
                <ng-container *ngIf="fileTypeFieldEnabled; else submitWithoutTypes">
                  <button mat-flat-button color="primary" type="button" (click)="specifyTypesForEachFile()" [disabled]="assetValidationInProgress || submitting">
                    {{ 'ManualEntry.Actions.SpecifyTypes' | translate }}
                  </button>
                  <button mat-stroked-button type="button" (click)="proceedWithoutSelectingTypes()" [disabled]="assetValidationInProgress || submitting">
                    {{ 'ManualEntry.Actions.SkipTypeSelection' | translate }}
                  </button>
                </ng-container>
                <ng-template #submitWithoutTypes>
                  <button mat-flat-button color="primary" type="button" (click)="proceedWithoutSelectingTypes()" [disabled]="assetValidationInProgress || submitting">
                    {{ 'ManualEntry.Actions.SubmitWithoutFileTypes' | translate }}
                  </button>
                </ng-template>
              </div>
            </ng-container>

            <ng-container *ngSwitchCase="'stage2'">
              <div class="stage-two-header">
                <h2>{{ 'ManualEntry.Stage2Title' | translate }}</h2>
                <p>{{ 'ManualEntry.Stage2Description' | translate }}</p>
              </div>

              <section class="file-type-hint" *ngIf="fileTypes.length">
                <h2>{{ 'ManualEntry.FileTypesTitle' | translate }}</h2>
                <p class="hint-text">{{ 'ManualEntry.FileTypesHint' | translate }}</p>
                <div class="file-type-list">
                  <div class="file-type-item" *ngFor="let type of fileTypes">
                    <span class="code">{{ type.code }}</span>
                    <span class="description" *ngIf="type.description && type.description !== type.code">{{ type.description }}</span>
                  </div>
                </div>
              </section>

              <section formArrayName="entries" class="files-section stage-two">
                <mat-card class="file-card" *ngFor="let entryGroup of entries.controls; let i = index; trackBy: trackByIndex" [formGroupName]="i">
                  <div class="file-card__header">
                    <h2>{{ 'ManualEntry.Stage2FileHeading' | translate:{ index: i + 1 } }}</h2>
                  </div>

                  <div class="stage-two-summary">
                    <div class="summary-item">
                      <span class="label">{{ 'ManualEntry.Fields.AssetId' | translate }}</span>
                      <span class="value">{{ entryGroup.get('assetId')?.value }}</span>
                    </div>
                    <div class="summary-item" *ngIf="assetMetadataMap.get(entryGroup.get('assetId')?.value)?.title">
                      <span class="label">{{ 'ManualEntry.Fields.AssetTitle' | translate }}</span>
                      <span class="value">{{ assetMetadataMap.get(entryGroup.get('assetId')?.value)?.title }}</span>
                    </div>
                    <div class="summary-item">
                      <span class="label">{{ 'ManualEntry.Fields.FileUrl' | translate }}</span>
                      <span class="value">{{ entryGroup.get('url')?.value }}</span>
                    </div>
                  </div>

                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>{{ 'ManualEntry.Fields.FileTitle' | translate }}</mat-label>
                    <input matInput formControlName="title" placeholder="{{ 'ManualEntry.Placeholders.FileTitle' | translate }}" />
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>{{ 'ManualEntry.Fields.Description' | translate }}</mat-label>
                    <textarea matInput formControlName="description" rows="2" placeholder="{{ 'ManualEntry.Placeholders.Description' | translate }}"></textarea>
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>{{ 'ManualEntry.Fields.FileType' | translate }}</mat-label>
                    <mat-select formControlName="type" [disabled]="submitting">
                      <mat-option *ngFor="let type of getFilteredFileTypes(entryGroup)" [value]="type.id">
                        {{ type.targetCode }}<span *ngIf="type.id"> (ID: {{ type.id }})</span>
                      </mat-option>
                    </mat-select>
                    <mat-error *ngIf="entryGroup.get('type')?.hasError('required')">{{ 'ManualEntry.Errors.FileTypeRequired' | translate }}</mat-error>
                  </mat-form-field>

                  <mat-checkbox formControlName="supplemental">{{ 'ManualEntry.Fields.Supplemental' | translate }}</mat-checkbox>
                </mat-card>
              </section>

              <div class="form-actions stage2-actions">
                <button mat-stroked-button type="button" (click)="returnToStageOne()" [disabled]="submitting">
                  {{ 'ManualEntry.Actions.BackToDetails' | translate }}
                </button>
                <button mat-flat-button color="primary" type="submit" [disabled]="submitting">
                  {{ 'ManualEntry.Actions.SubmitFiles' | translate }}
                </button>
              </div>
            </ng-container>
          </ng-container>

          <section class="export-options" *ngIf="entries.length">
            <h3>{{ 'ManualEntry.ExportOptions.Title' | translate }}</h3>
            <p class="export-options__description">{{ 'ManualEntry.ExportOptions.Description' | translate }}</p>
            <div class="export-options__grid">
              <div class="export-option">
                <mat-checkbox [(ngModel)]="exportValidOnSubmit" [ngModelOptions]="{ standalone: true }">
                  {{ 'ManualEntry.ExportOptions.ExportValidOnSubmit' | translate }}
                </mat-checkbox>
                <button
                  mat-stroked-button
                  type="button"
                  (click)="exportValidEntries()"
                  [disabled]="submitting || assetValidationInProgress">
                  <mat-icon>download</mat-icon>
                  <span>{{ 'ManualEntry.Actions.ExportValidNow' | translate }}</span>
                </button>
              </div>
              <div class="export-option">
                <mat-checkbox [(ngModel)]="exportInvalidOnSubmit" [ngModelOptions]="{ standalone: true }">
                  {{ 'ManualEntry.ExportOptions.ExportInvalidOnSubmit' | translate }}
                </mat-checkbox>
                <button
                  mat-stroked-button
                  type="button"
                  (click)="exportInvalidEntries()"
                  [disabled]="submitting || assetValidationInProgress">
                  <mat-icon>download</mat-icon>
                  <span>{{ 'ManualEntry.Actions.ExportInvalidNow' | translate }}</span>
                </button>
              </div>
              <div class="export-option">
                <mat-checkbox [(ngModel)]="exportDeletedOnSubmit" [ngModelOptions]="{ standalone: true }">
                  {{ 'ManualEntry.ExportOptions.ExportDeletedOnSubmit' | translate }}
                </mat-checkbox>
                <button
                  mat-stroked-button
                  type="button"
                  (click)="exportDeletedEntries()"
                  [disabled]="!deletedEntries.length || submitting || assetValidationInProgress">
                  <mat-icon>download</mat-icon>
                  <span>{{ 'ManualEntry.Actions.ExportDeletedNow' | translate }}</span>
                </button>
              </div>
            </div>
          </section>

          <section class="deleted-entries" *ngIf="deletedEntries.length">
            <h3>{{ 'ManualEntry.DeletedEntries.Title' | translate:{ count: deletedEntries.length } }}</h3>
            <p class="deleted-entries__description">{{ 'ManualEntry.DeletedEntries.Description' | translate }}</p>
            <mat-card class="deleted-entry" *ngFor="let entry of deletedEntries; let idx = index">
              <div class="deleted-entry__details">
                <div>
                  <span class="label">{{ 'ManualEntry.Fields.AssetId' | translate }}</span>
                  <span class="value">{{ getEntryFieldValue(entry.formGroup, 'assetId') || ('ManualEntry.Labels.AssetIdMissing' | translate) }}</span>
                </div>
                <div>
                  <span class="label">{{ 'ManualEntry.Fields.FileTitle' | translate }}</span>
                  <span class="value">{{ getEntryFieldValue(entry.formGroup, 'title') || ('ManualEntry.Labels.UntitledFile' | translate) }}</span>
                </div>
                <div>
                  <span class="label">{{ 'ManualEntry.Fields.FileUrl' | translate }}</span>
                  <span class="value value--url">{{ getEntryFieldValue(entry.formGroup, 'url') }}</span>
                </div>
                <div>
                  <span class="label">{{ 'ManualEntry.DeletedEntries.RemovedAt' | translate }}</span>
                  <span class="value">{{ entry.deletedAt | date:'medium' }}</span>
                </div>
                <div *ngIf="entry.reason">
                  <span class="label">{{ 'ManualEntry.DeletedEntries.Reason' | translate }}</span>
                  <span class="value">{{ entry.reason }}</span>
                </div>
              </div>
              <div class="deleted-entry__actions">
                <button mat-stroked-button color="primary" type="button" (click)="restoreDeletedEntry(idx)">
                  {{ 'ManualEntry.Actions.Restore' | translate }}
                </button>
                <button mat-button color="warn" type="button" (click)="permanentlyDeleteEntry(idx)">
                  {{ 'ManualEntry.Actions.DeleteForever' | translate }}
                </button>
              </div>
            </mat-card>
          </section>

          <mat-progress-bar *ngIf="submitting || assetValidationInProgress" mode="indeterminate"></mat-progress-bar>

          <div class="submission-result" *ngIf="submissionResult" [ngClass]="submissionResult.type">
            {{ submissionResult.message }}
          </div>
        </form>
      </div>
    </mat-tab>

    <!-- CSV Upload Tab - New Implementation -->
    <mat-tab [label]="'Tabs.CSVUpload' | translate">
      <div class="tab-content">
        <app-csv-processor
          [fileTypes]="fileTypes"
          [assetFileAndLinkTypes]="assetFileAndLinkTypes"
          (batchProcessed)="onBatchProcessed($event)"
          (downloadReady)="onDownloadReady($event)">
        </app-csv-processor>
      </div>
    </mat-tab>
  </mat-tab-group>

  <!-- Results Section -->
  <div *ngIf="showResults" class="results-section">
    <app-processing-results
      [processedData]="processedAssets"
      [downloadUrl]="mmsIdDownloadUrl"
      [showInstructions]="showWorkflowInstructions">
    </app-processing-results>
  </div>
</div>