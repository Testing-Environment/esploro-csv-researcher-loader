<div class="main-content">
  <div class="page-header">
    <h1>{{ 'Main.Title' | translate }}</h1>
    <p>{{ 'Main.Description' | translate }}</p>
  </div>

  <!-- Tab Navigation following Ex Libris patterns -->
  <mat-tab-group class="processing-tabs" animationDuration="300ms">
    <!-- Manual Entry Tab - Existing Implementation -->
    <mat-tab [label]="'Tabs.ManualEntry' | translate">
      <div class="tab-content">
        <form class="file-form" [formGroup]="form" (ngSubmit)="submitWithSelectedTypes()" novalidate>
          <ng-container [ngSwitch]="stage">
            <ng-container *ngSwitchCase="'stage1'">
              <!-- Optional field toggles with File Types gating -->
              <div class="field-toggles stage1-toggles">
                <mat-chip-list>
                  <!-- Required fields are implicit (Asset ID, File URL) -->
                  <mat-chip selected disabled>
                    <mat-icon>lock</mat-icon>
                    {{ 'ManualEntry.Fields.AssetId' | translate }}
                  </mat-chip>
                  <mat-chip selected disabled>
                    <mat-icon>lock</mat-icon>
                    {{ 'ManualEntry.Fields.FileUrl' | translate }}
                  </mat-chip>

                  <!-- File Types toggle controls Stage 2 availability -->
                  <mat-chip [selected]="fileTypesToggle" (click)="fileTypesToggle = !fileTypesToggle">
                    <mat-icon *ngIf="fileTypesToggle">check_circle</mat-icon>
                    <mat-icon *ngIf="!fileTypesToggle">add_circle_outline</mat-icon>
                    {{ 'ManualEntry.Fields.FileType' | translate }}
                  </mat-chip>

                  <!-- NEW: File Name toggle -->
                  <mat-chip [selected]="showFileName" (click)="showFileName = !showFileName">
                    <mat-icon *ngIf="showFileName">check_circle</mat-icon>
                    <mat-icon *ngIf="!showFileName">add_circle_outline</mat-icon>
                    {{ 'ManualEntry.Fields.FileTitle' | translate }}
                  </mat-chip>

                  <!-- NEW: File Description toggle -->
                  <mat-chip [selected]="showFileDescription" (click)="showFileDescription = !showFileDescription">
                    <mat-icon *ngIf="showFileDescription">check_circle</mat-icon>
                    <mat-icon *ngIf="!showFileDescription">add_circle_outline</mat-icon>
                    {{ 'ManualEntry.Fields.Description' | translate }}
                  </mat-chip>

                  <!-- NEW: Is Supplemental toggle -->
                  <mat-chip [selected]="showIsSupplemental" (click)="showIsSupplemental = !showIsSupplemental">
                    <mat-icon *ngIf="showIsSupplemental">check_circle</mat-icon>
                    <mat-icon *ngIf="!showIsSupplemental">add_circle_outline</mat-icon>
                    {{ 'ManualEntry.Fields.Supplemental' | translate }}
                  </mat-chip>
                </mat-chip-list>
              </div>
              <div class="stage-callout" role="note" *ngIf="fileTypesToggle">
                <mat-icon color="primary">info</mat-icon>
                <div class="stage-callout__content">
                  <h2>{{ 'ManualEntry.Stage1CalloutTitle' | translate }}</h2>
                  <p>{{ 'ManualEntry.Stage1CalloutDescription' | translate }}</p>
                  <p>{{ 'ManualEntry.Stage1CalloutTypeNext' | translate }}</p>
                </div>
              </div>

              <section class="file-type-hint" *ngIf="fileTypes.length">
                <h2>{{ 'ManualEntry.FileTypesTitle' | translate }}</h2>
                <p class="hint-text">{{ 'ManualEntry.FileTypesHint' | translate }}</p>
                <div class="file-type-list">
                  <div class="file-type-item" *ngFor="let type of fileTypes">
                    <span class="code">{{ type.code }}</span>
                    <span class="description" *ngIf="type.description && type.description !== type.code">{{ type.description }}</span>
                  </div>
                </div>
              </section>

              <section formArrayName="entries" class="files-section">
                <mat-card class="file-card" *ngFor="let entryGroup of entries.controls; let i = index; trackBy: trackByIndex" [formGroupName]="i" [ngClass]="{ 'invalid-asset': isAssetInvalid(i) }">
                  <div class="file-card__header">
                    <h2>{{ 'ManualEntry.Stage1FileHeading' | translate:{ index: i + 1 } }}</h2>
                    <button mat-icon-button type="button" color="warn" (click)="removeEntry(i)" *ngIf="entries.length > 1">
                      <mat-icon>delete</mat-icon>
                    </button>
                  </div>

                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>{{ 'ManualEntry.Fields.AssetId' | translate }}</mat-label>
                    <input matInput formControlName="assetId" placeholder="e.g. 12345678900001234" />
                    <mat-error *ngIf="entryGroup.get('assetId')?.hasError('required')">{{ 'ManualEntry.Errors.AssetIdRequired' | translate }}</mat-error>
                    <mat-error *ngIf="entryGroup.get('assetId')?.hasError('invalidAsset')">{{ 'ManualEntry.Errors.AssetIdInvalid' | translate }}</mat-error>
                  </mat-form-field>

                  <mat-form-field *ngIf="showFileName" appearance="outline" class="full-width">
                    <mat-label>{{ 'ManualEntry.Fields.FileTitle' | translate }}</mat-label>
                    <input matInput formControlName="title" placeholder="{{ 'ManualEntry.Placeholders.FileTitle' | translate }}" />
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>{{ 'ManualEntry.Fields.FileUrl' | translate }}</mat-label>
                    <input matInput formControlName="url" placeholder="https://example.com/file.pdf" />
                    <mat-hint>{{ 'ManualEntry.Hints.FileUrl' | translate }}</mat-hint>
                    <mat-error *ngIf="entryGroup.get('url')?.hasError('required')">{{ 'ManualEntry.Errors.UrlRequired' | translate }}</mat-error>
                    <mat-error *ngIf="entryGroup.get('url')?.hasError('pattern')">{{ 'ManualEntry.Errors.UrlFormat' | translate }}</mat-error>
                  </mat-form-field>

                  <mat-form-field *ngIf="showFileDescription" appearance="outline" class="full-width">
                    <mat-label>{{ 'ManualEntry.Fields.Description' | translate }}</mat-label>
                    <textarea matInput formControlName="description" rows="2" placeholder="{{ 'ManualEntry.Placeholders.Description' | translate }}"></textarea>
                  </mat-form-field>

                  <mat-checkbox *ngIf="showIsSupplemental" formControlName="supplemental">{{ 'ManualEntry.Fields.Supplemental' | translate }}</mat-checkbox>
                </mat-card>
              </section>

              <div class="add-file-row">
                <button mat-stroked-button color="primary" type="button" (click)="addEntry()">
                  <mat-icon>add</mat-icon>
                  <span>{{ 'ManualEntry.Actions.AddAnother' | translate }}</span>
                </button>
              </div>

              <div class="form-actions stage1-actions">
                <!-- When File Types toggle is ON, guide to Stage 2 -->
                <button *ngIf="fileTypesToggle"
                        mat-flat-button color="primary" type="button"
                        (click)="specifyTypesForEachFile()"
                        [disabled]="assetValidationInProgress || submitting">
                  {{ 'ManualEntry.Actions.NextSpecifyTypes' | translate }}
                </button>
                <!-- When File Types toggle is OFF, skip Stage 2 and validate â†’ review -->
                <button *ngIf="!fileTypesToggle"
                        mat-flat-button color="primary" type="button"
                        (click)="proceedToValidationAndReview()"
                        [disabled]="assetValidationInProgress || submitting">
                  {{ 'ManualEntry.Actions.NextValidateEntries' | translate }}
                </button>
              </div>
            </ng-container>

            <ng-container *ngSwitchCase="'stage2'">
              <div class="stage-two-header">
                <h2>{{ 'ManualEntry.Stage2Title' | translate }}</h2>
                <p>{{ 'ManualEntry.Stage2Description' | translate }}</p>
              </div>

              <section class="file-type-hint" *ngIf="fileTypes.length">
                <h2>{{ 'ManualEntry.FileTypesTitle' | translate }}</h2>
                <p class="hint-text">{{ 'ManualEntry.FileTypesHint' | translate }}</p>
                <div class="file-type-list">
                  <div class="file-type-item" *ngFor="let type of fileTypes">
                    <span class="code">{{ type.code }}</span>
                    <span class="description" *ngIf="type.description && type.description !== type.code">{{ type.description }}</span>
                  </div>
                </div>
              </section>

              <section formArrayName="entries" class="files-section stage-two">
                <mat-card class="file-card" *ngFor="let entryGroup of entries.controls; let i = index; trackBy: trackByIndex" [formGroupName]="i">
                  <div class="file-card__header">
                    <h2>{{ 'ManualEntry.Stage2FileHeading' | translate:{ index: i + 1 } }}</h2>
                  </div>

                  <div class="stage-two-summary">
                    <div class="summary-item">
                      <span class="label">{{ 'ManualEntry.Fields.AssetId' | translate }}</span>
                      <span class="value">{{ entryGroup.get('assetId')?.value }}</span>
                    </div>
                    <div class="summary-item" *ngIf="assetMetadataMap.get(entryGroup.get('assetId')?.value)?.title">
                      <span class="label">{{ 'ManualEntry.Fields.AssetTitle' | translate }}</span>
                      <span class="value">{{ assetMetadataMap.get(entryGroup.get('assetId')?.value)?.title }}</span>
                    </div>
                    <div class="summary-item">
                      <span class="label">{{ 'ManualEntry.Fields.FileUrl' | translate }}</span>
                      <span class="value">{{ entryGroup.get('url')?.value }}</span>
                    </div>
                  </div>

                  <mat-form-field *ngIf="showFileName" appearance="outline" class="full-width">
                    <mat-label>{{ 'ManualEntry.Fields.FileTitle' | translate }}</mat-label>
                    <input matInput formControlName="title" placeholder="{{ 'ManualEntry.Placeholders.FileTitle' | translate }}" />
                  </mat-form-field>

                  <mat-form-field *ngIf="showFileDescription" appearance="outline" class="full-width">
                    <mat-label>{{ 'ManualEntry.Fields.Description' | translate }}</mat-label>
                    <textarea matInput formControlName="description" rows="2" placeholder="{{ 'ManualEntry.Placeholders.Description' | translate }}"></textarea>
                  </mat-form-field>

                  <mat-form-field *ngIf="fileTypesToggle" appearance="outline" class="full-width">
                    <mat-label>{{ 'ManualEntry.Fields.FileType' | translate }}</mat-label>
                    <mat-select formControlName="type" [disabled]="submitting">
                      <mat-option *ngFor="let type of getFilteredFileTypes($any(entryGroup))" [value]="type.id">
                        {{ type.targetCode }}<span *ngIf="type.id"> (ID: {{ type.id }})</span>
                      </mat-option>
                    </mat-select>
                  </mat-form-field>

                  <mat-checkbox *ngIf="showIsSupplemental" formControlName="supplemental">{{ 'ManualEntry.Fields.Supplemental' | translate }}</mat-checkbox>
                </mat-card>
              </section>

              <div class="form-actions stage2-actions">
                <button mat-stroked-button type="button" (click)="returnToStageOne()" [disabled]="submitting">
                  {{ 'ManualEntry.Actions.BackToDetails' | translate }}
                </button>
                <button mat-flat-button color="primary" type="button" (click)="proceedToValidationAndReview()" [disabled]="submitting">
                  {{ 'ManualEntry.Actions.NextValidateEntries' | translate }}
                </button>
              </div>
            </ng-container>

            <!-- Stage 3: Review & Confirm -->
            <ng-container *ngSwitchCase="'stage3'">
              <div class="stage-three-header">
                <h2>{{ 'Review.Title' | translate }}</h2>
                <p>{{ 'Review.Description' | translate }}</p>
              </div>

              <section class="review-cards">
                <mat-card class="review-card">
                  <h3>{{ 'Review.AssetsCount' | translate }}</h3>
                  <p class="count">{{ reviewAssetsCount }}</p>
                </mat-card>
                <mat-card class="review-card">
                  <h3>{{ 'Review.FilesCount' | translate }}</h3>
                  <p class="count">{{ reviewFilesCount }}</p>
                </mat-card>
                <mat-card class="review-card">
                  <h3>{{ 'Review.UniqueUrlsCount' | translate }}</h3>
                  <p class="count">{{ reviewUniqueUrlsCount }}</p>
                </mat-card>
              </section>

              <div class="form-actions stage3-actions">
                <button mat-stroked-button type="button" (click)="backFromReview()" [disabled]="submitting">
                  {{ 'Review.Actions.Back' | translate }}
                </button>
                <button mat-flat-button color="primary" type="button" (click)="runImportJob()" [disabled]="submitting">
                  {{ 'Review.Actions.RunJob' | translate }}
                </button>
              </div>
            </ng-container>
          </ng-container>

          <mat-progress-bar *ngIf="submitting || assetValidationInProgress" mode="indeterminate"></mat-progress-bar>

          <div class="submission-result" *ngIf="submissionResult" [ngClass]="submissionResult.type">
            {{ submissionResult.message }}
          </div>
        </form>
      </div>
    </mat-tab>

    <!-- CSV Upload Tab - New Implementation -->
    <mat-tab [label]="'Tabs.CSVUpload' | translate">
      <div class="tab-content">
        <app-csv-processor
          [fileTypes]="fileTypes"
          [assetFileAndLinkTypes]="assetFileAndLinkTypes"
          (batchProcessed)="onBatchProcessed($event)"
          (downloadReady)="onDownloadReady($event)">
        </app-csv-processor>
      </div>
    </mat-tab>
  </mat-tab-group>

  <!-- Results Section -->
  <div *ngIf="showResults" class="results-section">
    <app-processing-results
      [processedData]="processedAssets"
      [downloadUrl]="mmsIdDownloadUrl"
      [showInstructions]="showWorkflowInstructions">
    </app-processing-results>
  </div>
</div>